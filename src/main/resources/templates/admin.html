<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Bereich</title>
    <link rel="stylesheet" href="/css/styles.css">
    <meta name="_csrf" content="" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" content="" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="fullcontainer2">
    <a th:href="@{/index}" class="top-left-button" title="Zurück zur Übersicht">Zurück zur Übersicht</a>

    <h1>Admin-Bereich</h1>
    <div class="block">
    <section>
        <h2>Registrierung eines Studenten</h2>
        <form id="registrationForm">
            <div>
                <label for="vorname">Vorname:</label>
                <input type="text" id="vorname" name="vorname" required>
            </div>

            <div>
                <label for="nachname">Nachname:</label>
                <input type="text" id="nachname" name="nachname" required>
            </div>

            <div>
                <label for="email">E-Mail:</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div>
                <label for="passwort">Passwort:</label>
                <input type="password" id="passwort" name="passwort" required minlength="8" placeholder="Mindestens 8 Zeichen">
            </div>

            <div>
                <label for="seminargruppe">Seminargruppe:</label>
                <select id="seminargruppe" name="seminargruppeId" required>
                    <option value="" disabled selected>Seminargruppe wählen...</option>
                </select>
            </div>

            <div>
                <label for="rolle">Rolle:</label>
                <select id="rolle" name="rolle" required>
                    <option value="" disabled selected>Rolle wählen...</option>
                </select>
            </div>

            <button type="submit">Registrieren</button>
        </form>
        <div class="message" id="message"></div>
    </section>

    <section>
        <h2>Student löschen</h2>
        <form id="deleteStudentForm">
            <div>
                <label for="deleteEmail">E-Mail-Adresse des Studenten:</label>
                <input type="email" id="deleteEmail" name="deleteEmail" required>
            </div>
            <button type="submit">Student löschen</button>
        </form>
        <div class="message" id="deleteMessage"></div>
    </section>


    <!-- Kalendereinträge verwalten -->
    <section>
        <h2>Kalendereinträge verwalten</h2>
        <form id="kalendereintragForm">
            <div>
                <label for="beschreibung">Beschreibung:</label>
                <input type="text" id="beschreibung" placeholder="Beschreibung" required>
            </div>

            <div>
                <label for="eintragsdatum">Datum:</label>
                <input type="date" id="eintragsdatum" required>
            </div>

            <div>
                <label for="eventType">Event-Typ:</label>
                <select id="eventType" required>
                    <option value="" disabled selected>Event-Typ wählen...</option>
                    <option value="PRUEFUNG">Prüfung</option>
                    <option value="EVENT">Event</option>
                </select>
            </div>

            <div>
                <label for="startTime">Startzeit:</label>
                <input type="time" id="startTime" required>
            </div>

            <div>
                <label for="endTime">Endzeit:</label>
                <input type="time" id="endTime" required>
            </div>

            <div>
                <label for="seminargruppeSelect">Seminargruppe:</label>
                <select id="seminargruppeSelect" required>
                    <option value="" disabled selected>Seminargruppe wählen...</option>
                </select>
            </div>

            <button type="submit">Kalendereintrag hinzufügen</button>
        </form>
        <div id="kalendereintragMessage" class="message"></div>
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Beschreibung</th>
                <th>Datum</th>
                <th>Startzeit</th>
                <th>Endzeit</th>
                <th>Event-Typ</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody id="kalendereintragTableBody">
            <!-- Kalendereinträge werden hier dynamisch eingefügt -->
            </tbody>
        </table>
     </section>
    </div>
</div>


<script>
    // Seminargruppen laden und in das Dropdown-Menü für die Registrierung einfügen
    async function loadSeminargruppen() {
        const seminargruppeSelect = document.getElementById('seminargruppe');
        try {
            const response = await fetch('/api/seminargruppen', {
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`Fehler beim Abrufen der Seminargruppen: ${response.statusText}`);
            }

            const seminargruppen = await response.json();

            if (seminargruppen.length === 0) {
                alert("Keine Seminargruppen verfügbar. Bitte kontaktiere den Administrator.");
            }

            seminargruppen.forEach(group => {
                const option = document.createElement('option');
                option.value = group.seminargruppeId;
                option.textContent = group.name;
                seminargruppeSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Netzwerk- oder Serverfehler beim Laden der Seminargruppen:', error);
            alert("Fehler beim Abrufen der Seminargruppen. Bitte später erneut versuchen.");
        }
    }

    // Rollen laden und in das Dropdown-Menü für die Registrierung einfügen
    async function loadRollen() {
        const rolleSelect = document.getElementById('rolle');
        try {
            const response = await fetch('/api/rollen', {
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`Fehler beim Abrufen der Rollen: ${response.statusText}`);
            }

            const rollen = await response.json();

            if (rollen.length === 0) {
                alert("Keine Rollen verfügbar. Bitte kontaktiere den Administrator.");
            }

            rollen.forEach(rolle => {
                const option = document.createElement('option');
                option.value = rolle;
                option.textContent = rolle;
                rolleSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Netzwerk- oder Serverfehler beim Laden der Rollen:', error);
            alert("Fehler beim Abrufen der Rollen. Bitte später erneut versuchen.");
        }
    }

    // Registrierung absenden via AJAX
    document.getElementById('registrationForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = {
            vorname: document.getElementById('vorname').value.trim(),
            nachname: document.getElementById('nachname').value.trim(),
            email: document.getElementById('email').value.trim(),
            passwort: document.getElementById('passwort').value,
            seminargruppeId: parseInt(document.getElementById('seminargruppe').value),
            rolle: document.getElementById('rolle').value
        };

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const messageEl = document.getElementById('message');
        messageEl.textContent = '';
        messageEl.className = 'message';

        try {
            const response = await fetch('/api/students/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(formData)
            });

            const responseText = await response.text();

            if (response.ok) {
                messageEl.textContent = responseText || 'Student erfolgreich registriert.';
                messageEl.classList.add('success');
                document.getElementById('registrationForm').reset();
            } else {
                messageEl.textContent = `Fehler: ${responseText || 'Registrierung fehlgeschlagen.'}`;
                messageEl.classList.add('error');
            }
        } catch (error) {
            messageEl.textContent = `Netzwerkfehler: ${error.message}`;
            messageEl.classList.add('error');
        }
    });

    // Seminargruppen für den Kalender laden
    async function fetchSeminargruppenForKalender() {
        try {
            const response = await fetch('/kalender/seminargruppen');
            if (!response.ok) throw new Error('Fehler beim Laden der Seminargruppen.');
            const seminargruppen = await response.json();
            const select = document.getElementById('seminargruppeSelect');
            select.innerHTML = '<option value="" disabled selected>Seminargruppe wählen...</option>';
            seminargruppen.forEach(gruppe => {
                const option = document.createElement('option');
                option.value = gruppe.seminargruppeId;
                option.textContent = gruppe.name;
                select.appendChild(option);
            });
        } catch (error) {
            alert('Fehler beim Laden der Seminargruppen.');
            console.error(error);
        }
    }

    // Kalendereinträge laden und darstellen
    async function fetchKalendereintraege() {
        try {
            const response = await fetch('/kalender/kalendereintraege');
            if (!response.ok) {
                throw new Error('Fehler beim Abrufen der Kalendereinträge');
            }
            const kalendereintraege = await response.json();
            const tableBody = document.getElementById('kalendereintragTableBody');
            tableBody.innerHTML = '';
            kalendereintraege.forEach(eintrag => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${eintrag.kalendereintragId}</td>
                        <td>${eintrag.beschreibung}</td>
                        <td>${eintrag.eintragsdatum}</td>
                        <td>${eintrag.startTime}</td>
                        <td>${eintrag.endTime}</td>
                        <td>${eintrag.eventType}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteKalendereintrag(${eintrag.kalendereintragId})">Löschen</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            displayMessage('kalendereintragMessage', error.message, 'error');
        }
    }

    async function addKalendereintrag(beschreibung, eintragsdatum, eventType, startTime, endTime, seminargruppeId) {
        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const payload = { beschreibung, eintragsdatum, eventType, startTime, endTime, seminargruppeId };
            const response = await fetch('/kalender/kalendereintrag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorObj = await response.json();
                throw new Error(errorObj.error || 'Fehler beim Hinzufügen des Kalendereintrags.');
            }
            displayMessage('kalendereintragMessage', 'Kalendereintrag erfolgreich hinzugefügt!', 'success');
            fetchKalendereintraege();
        } catch (error) {
            displayMessage('kalendereintragMessage', error.message, 'error');
            console.error('Fehler beim Hinzufügen des Kalendereintrags:', error);
        }
    }

    async function deleteKalendereintrag(kalendereintragId) {
        if (!confirm('Sind Sie sicher, dass Sie diesen Kalendereintrag löschen möchten?')) return;

        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const response = await fetch(`/kalender/kalendereintrag/${kalendereintragId}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Fehler beim Löschen des Kalendereintrags.');
            }
            displayMessage('kalendereintragMessage', 'Kalendereintrag erfolgreich gelöscht!', 'success');
            fetchKalendereintraege();
        } catch (error) {
            displayMessage('kalendereintragMessage', error.message, 'error');
        }
    }

    function displayMessage(elementId, message, type) {
        const messageEl = document.getElementById(elementId);
        messageEl.textContent = message;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }

    // Neuer Code für das Löschen eines Studenten per E-Mail
    document.getElementById('deleteStudentForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const emailToDelete = document.getElementById('deleteEmail').value.trim();
        const messageEl = document.getElementById('deleteMessage');
        messageEl.textContent = '';
        messageEl.className = 'message';

        if (!emailToDelete) {
            messageEl.textContent = 'Bitte eine E-Mail-Adresse eingeben.';
            messageEl.classList.add('error');
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        try {
            const response = await fetch(`/api/students/by-email/${encodeURIComponent(emailToDelete)}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });

            if (response.ok) {
                const responseText = await response.text();
                messageEl.textContent = responseText || 'Student erfolgreich gelöscht.';
                messageEl.classList.add('success');
                document.getElementById('deleteStudentForm').reset();
            } else if (response.status === 404) {
                messageEl.textContent = 'Kein Student mit dieser E-Mail gefunden.';
                messageEl.classList.add('error');
            } else {
                const errorText = await response.text();
                messageEl.textContent = `Fehler: ${errorText || 'Löschen fehlgeschlagen.'}`;
                messageEl.classList.add('error');
            }
        } catch (error) {
            messageEl.textContent = `Netzwerkfehler: ${error.message}`;
            messageEl.classList.add('error');
        }
    });

    window.onload = function () {
        loadSeminargruppen();
        loadRollen();
        fetchSeminargruppenForKalender();
        fetchKalendereintraege();
    };
</script>
<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
</script>

</body>
</html>
